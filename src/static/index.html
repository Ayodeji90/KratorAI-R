<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KratorAI - AI Editor</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --accent-green: #10b981;
            --accent-yellow: #fbbf24;
            --bg-black: #0a0a0a;
            --bg-dark: #111111;
            --bg-card: #1a1a1a;
            --bg-hover: #252525;
            --text-primary: #ffffff;
            --text-secondary: #a1a1aa;
            --text-muted: #71717a;
            --border: #27272a;
            --border-light: #3f3f46;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-black);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }

        .app-layout {
            display: flex;
            min-height: 100vh;
        }

        /* ===== SIDEBAR ===== */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            height: 100vh;
            width: 260px;
            background: var(--bg-dark);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            z-index: 100;
        }

        .sidebar-logo {
            padding: 1.5rem 1.25rem;
            border-bottom: 1px solid var(--border);
        }

        .sidebar-logo h1 {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-green), var(--accent-yellow));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .sidebar-nav {
            flex: 1;
            padding: 1rem 0.75rem;
            overflow-y: auto;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            margin-bottom: 0.25rem;
            color: var(--text-secondary);
            text-decoration: none;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .nav-item:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(251, 191, 36, 0.15));
            color: var(--text-primary);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .nav-item svg {
            width: 20px;
            height: 20px;
        }

        .sidebar-bottom {
            padding: 1.25rem;
            border-top: 1px solid var(--border);
        }

        .credits-badge {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(251, 191, 36, 0.2));
            border: 1px solid rgba(16, 185, 129, 0.4);
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 0.75rem;
            text-align: center;
        }

        .credits-number {
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-green), var(--accent-yellow));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .credits-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        .upgrade-btn {
            width: 100%;
            padding: 0.75rem;
            background: linear-gradient(135deg, var(--accent-green), var(--accent-yellow));
            border: none;
            border-radius: 0.5rem;
            color: var(--bg-black);
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 0.75rem;
        }

        .upgrade-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(16, 185, 129, 0.3);
        }

        .logout-link {
            display: block;
            text-align: center;
            color: #ef4444;
            font-size: 0.875rem;
            text-decoration: none;
            padding: 0.5rem;
            border-radius: 0.375rem;
            transition: all 0.2s ease;
        }

        .logout-link:hover {
            background: rgba(239, 68, 68, 0.1);
        }

        /* ===== MAIN CONTENT ===== */
        .main-content {
            margin-left: 260px;
            flex: 1;
            min-height: 100vh;
            overflow-y: auto;
        }

        .content-wrapper {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Header Card */
        .header-card {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(251, 191, 36, 0.1));
            border: 1px solid var(--border-light);
            border-radius: 1rem;
            padding: 2rem;
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title {
            font-size: 1.75rem;
            font-weight: 700;
        }

        .header-credits {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--bg-card);
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            border: 1px solid rgba(16, 185, 129, 0.4);
        }

        .header-credits-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .header-credits-value {
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-green), var(--accent-yellow));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Section */
        .section {
            margin-bottom: 2.5rem;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 1rem;
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .section-subtitle {
            font-size: 0.875rem;
            color: var(--text-muted);
            max-width: 600px;
        }

        .view-all-link {
            color: var(--accent-yellow);
            text-decoration: none;
            font-size: 0.875rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            transition: all 0.2s ease;
        }

        .view-all-link:hover {
            color: var(--accent-green);
            gap: 0.5rem;
        }

        /* Template Carousel */
        .template-carousel {
            display: flex;
            gap: 1rem;
            overflow-x: auto;
            padding-bottom: 1rem;
            scroll-behavior: smooth;
        }

        .template-carousel::-webkit-scrollbar {
            height: 8px;
        }

        .template-carousel::-webkit-scrollbar-track {
            background: var(--bg-card);
            border-radius: 4px;
        }

        .template-carousel::-webkit-scrollbar-thumb {
            background: var(--border-light);
            border-radius: 4px;
        }

        .template-carousel::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        .template-card {
            min-width: 280px;
            height: 180px;
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 0.75rem;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .template-card:hover {
            transform: translateY(-4px);
            border-color: var(--accent-green);
            box-shadow: 0 8px 24px rgba(16, 185, 129, 0.2);
        }

        .template-card.selected {
            border-color: var(--accent-green);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
        }

        .template-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .template-card-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.8), transparent);
            padding: 1rem;
            color: white;
        }

        .template-name {
            font-weight: 600;
            font-size: 0.875rem;
        }

        /* Card */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.25rem;
        }

        .card-title {
            font-size: 1.125rem;
            font-weight: 600;
        }

        /* Upload Button */
        .upload-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--bg-hover);
            border: 1px solid var(--border-light);
            border-radius: 0.5rem;
            color: var(--text-primary);
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .upload-btn:hover {
            border-color: var(--accent-green);
            background: rgba(16, 185, 129, 0.1);
        }

        .upload-btn svg {
            width: 16px;
            height: 16px;
        }

        #imageInput {
            display: none;
        }

        /* Textarea */
        .textarea {
            width: 100%;
            min-height: 140px;
            background: var(--bg-hover);
            border: 1px solid var(--border-light);
            border-radius: 0.75rem;
            padding: 1rem;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.9375rem;
            resize: vertical;
            line-height: 1.6;
            transition: all 0.2s ease;
        }

        .textarea:focus {
            outline: none;
            border-color: var(--accent-green);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .textarea::placeholder {
            color: var(--text-muted);
        }

        .helper-text {
            margin-top: 0.75rem;
            font-size: 0.8125rem;
            color: var(--text-muted);
            line-height: 1.5;
        }

        /* Template Preview & Content Layout */
        .card-content {
            display: flex;
            gap: 1.5rem;
            align-items: flex-start;
        }

        .template-preview {
            flex-shrink: 0;
            width: 200px;
        }

        .template-preview-image {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
            border-radius: 0.75rem;
            border: 2px solid var(--border-light);
            background: var(--bg-hover);
            display: none;
        }

        .template-preview-image.active {
            display: block;
        }

        .template-preview-placeholder {
            width: 100%;
            aspect-ratio: 1;
            border-radius: 0.75rem;
            border: 2px dashed var(--border-light);
            background: var(--bg-hover);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            font-size: 0.875rem;
            text-align: center;
            padding: 1rem;
        }

        .template-preview-placeholder.hidden {
            display: none;
        }

        .content-right {
            flex: 1;
            min-width: 0;
        }

        /* Image Preview */
        .image-preview-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .image-preview-item {
            position: relative;
            aspect-ratio: 1;
            background: var(--bg-hover);
            border: 1px solid var(--border-light);
            border-radius: 0.5rem;
            overflow: hidden;
        }

        .image-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-preview-remove {
            position: absolute;
            top: 0.25rem;
            right: 0.25rem;
            width: 24px;
            height: 24px;
            background: rgba(0, 0, 0, 0.7);
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .image-preview-item:hover .image-preview-remove {
            opacity: 1;
        }

        /* Textarea Container with Voice Button */
        .textarea-container {
            position: relative;
        }

        .voice-btn {
            position: absolute;
            bottom: 0.75rem;
            right: 0.75rem;
            width: 40px;
            height: 40px;
            background: var(--primary);
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3);
        }

        .voice-btn:hover {
            background: var(--primary-hover);
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
        }

        .voice-btn svg {
            width: 20px;
            height: 20px;
        }

        .voice-btn.recording {
            background: #ef4444;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }
        }

        /* Voice Conversation Modal */
        .voice-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }

        .voice-modal.active {
            display: flex;
        }

        .voice-modal-content {
            background: var(--bg-card);
            border-radius: 1.5rem;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .voice-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .voice-modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .voice-modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 1.5rem;
            line-height: 1;
            padding: 0.25rem;
        }

        .voice-conversation {
            min-height: 300px;
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 1.5rem;
        }

        .voice-message {
            margin-bottom: 1rem;
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            line-height: 1.5;
        }

        .voice-message.ai {
            background: var(--bg-hover);
            color: var(--text-primary);
            margin-right: 20%;
        }

        .voice-message.user {
            background: var(--primary);
            color: white;
            margin-left: 20%;
            text-align: right;
        }

        .voice-status {
            text-align: center;
            padding: 1.5rem;
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        .voice-status-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 1rem;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .voice-status-icon.listening {
            animation: pulse 1.5s infinite;
        }

        .voice-status-icon.speaking {
            background: #10b981;
        }

        /* Generate Section */
        .generate-section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 1rem;
            padding: 2rem;
            text-align: center;
        }

        .generate-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .generate-subtitle {
            color: var(--text-muted);
            font-size: 0.875rem;
            margin-bottom: 1.5rem;
        }

        .generate-btn {
            width: 100%;
            max-width: 400px;
            padding: 1rem 2rem;
            background: linear-gradient(135deg, var(--accent-green), var(--accent-yellow));
            border: none;
            border-radius: 0.75rem;
            color: var(--bg-black);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .generate-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 12px 28px rgba(16, 185, 129, 0.4);
        }

        .generate-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 240px;
            }

            .main-content {
                margin-left: 240px;
            }

            .template-card {
                min-width: 240px;
            }

            .image-preview-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 640px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .main-content {
                margin-left: 0;
            }

            .content-wrapper {
                padding: 1rem;
            }

            .header-card {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }
        }
    </style>
</head>

<body>
    <div class="app-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-logo">
                <h1>kratorAI</h1>
            </div>

            <nav class="sidebar-nav">
                <a href="#" class="nav-item active">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span>Playground</span>
                </a>
                <a href="#" class="nav-item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span>Design History</span>
                </a>
                <a href="#" class="nav-item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
                    </svg>
                    <span>My Library</span>
                </a>
                <a href="#" class="nav-item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z" />
                    </svg>
                    <span>Templates</span>
                </a>
                <a href="#" class="nav-item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                    </svg>
                    <span>Creator</span>
                </a>
                <a href="#" class="nav-item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                    <span>Referrals</span>
                </a>
                <a href="#" class="nav-item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
                    </svg>
                    <span>Pricing</span>
                </a>
                <a href="#" class="nav-item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
                    </svg>
                    <span>Billing</span>
                </a>
                <a href="#" class="nav-item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    <span>Settings</span>
                </a>

                <!-- NEW: Register Business Button -->
                <a href="/static/onboarding.html" class="nav-item" id="registerBusinessBtn"
                    style="color: var(--accent-yellow);">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                    </svg>
                    <span>Register Business</span>
                </a>
            </nav>

            <div class="sidebar-bottom">
                <div class="credits-badge">
                    <div class="credits-number">27</div>
                    <div class="credits-label">Credits Remaining</div>
                </div>
                <button class="upgrade-btn">Upgrade</button>
                <a href="#" class="logout-link">Log out</a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="content-wrapper">
                <!-- Header Card -->
                <div class="header-card">
                    <h1 class="header-title">AI Editor</h1>
                    <div class="header-credits">
                        <span class="header-credits-label">Credits:</span>
                        <span class="header-credits-value">27</span>
                    </div>
                </div>

                <!-- Select Template Section -->
                <section class="section">
                    <div class="section-header">
                        <div>
                            <h2 class="section-title">Select Template</h2>
                            <p class="section-subtitle">Choose a template to start editing. Templates with frame
                                structure can provide greater flexibility.</p>
                        </div>
                        <a href="#" class="view-all-link">
                            View All Templates
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none"
                                viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 5l7 7-7 7" />
                            </svg>
                        </a>
                    </div>

                    <div class="template-carousel" id="templateCarousel">
                        <div class="template-card" data-template="template-01">
                            <img src="/static/template_01.jpg" alt="Template 1">
                            <div class="template-card-overlay">
                                <div class="template-name">Template 01</div>
                            </div>
                        </div>
                        <div class="template-card" data-template="template-02">
                            <img src="/static/template_02.jpg" alt="Template 2">
                            <div class="template-card-overlay">
                                <div class="template-name">Template 02</div>
                            </div>
                        </div>
                        <div class="template-card" data-template="template-03">
                            <img src="/static/template_03.jpg" alt="Template 3">
                            <div class="template-card-overlay">
                                <div class="template-name">Template 03</div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Describe Your Changes Section -->
                <section class="section">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Describe your changes</h3>
                            <button class="upload-btn" onclick="document.getElementById('imageInput').click()">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                </svg>
                                <span id="uploadBtnText">Upload (0/2)</span>
                            </button>
                            <input type="file" id="imageInput" accept="image/*" multiple>
                        </div>

                        <div class="card-content">
                            <!-- Template Preview on Left -->
                            <div class="template-preview">
                                <img id="selectedTemplatePreview" class="template-preview-image" src=""
                                    alt="Selected Template">
                                <div id="templatePreviewPlaceholder" class="template-preview-placeholder">
                                    Select a template to preview
                                </div>
                            </div>

                            <!-- Content on Right -->
                            <div class="content-right">
                                <div class="textarea-container">
                                    <textarea class="textarea" id="changesTextarea"
                                        placeholder="For the best results, mention the aspects you want to edit (e.g. Change the color and layout).&#10;&#10;Aspects mentioned here will be automatically selected."></textarea>
                                    <button class="voice-btn" id="voiceBtn" title="Use voice to describe changes">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                            stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                                        </svg>
                                    </button>
                                </div>

                                <p class="helper-text">Be specific about what you want to change in the template. Upload
                                    images or logos to add to your design (max 2).</p>

                                <div class="image-preview-grid" id="imagePreviewGrid"></div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Ready to Generate Section -->
                <section class="generate-section">
                    <h3 class="generate-title">Ready to Generate</h3>
                    <p class="generate-subtitle" id="generateSubtitle">Select a template to begin</p>
                    <button class="generate-btn" id="generateBtn" disabled>Generate AI Edit</button>
                </section>
            </div>
        </main>

        <!-- Voice Conversation Modal -->
        <div class="voice-modal" id="voiceModal">
            <div class="voice-modal-content">
                <div class="voice-modal-header">
                    <h3 class="voice-modal-title">Voice Assistant</h3>
                    <button class="voice-modal-close" id="voiceModalClose">&times;</button>
                </div>
                <div class="voice-conversation" id="voiceConversation">
                    <div class="voice-status">
                        <div class="voice-status-icon" id="voiceStatusIcon">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor" style="width: 24px; height: 24px">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                            </svg>
                        </div>
                        <p id="voiceStatusText">Initializing...</p>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // State
        let selectedTemplate = null;
        let selectedTemplateFile = null;
        let templateDescription = null;
        let uploadedImages = [];
        const MAX_IMAGES = 2;

        // DOM Elements
        const templateCards = document.querySelectorAll('.template-card');
        const imageInput = document.getElementById('imageInput');
        const uploadBtnText = document.getElementById('uploadBtnText');
        const imagePreviewGrid = document.getElementById('imagePreviewGrid');
        const changesTextarea = document.getElementById('changesTextarea');
        const generateBtn = document.getElementById('generateBtn');
        const generateSubtitle = document.getElementById('generateSubtitle');
        const selectedTemplatePreview = document.getElementById('selectedTemplatePreview');
        const templatePreviewPlaceholder = document.getElementById('templatePreviewPlaceholder');
        const voiceBtn = document.getElementById('voiceBtn');
        const voiceModal = document.getElementById('voiceModal');
        const voiceModalClose = document.getElementById('voiceModalClose');
        const voiceConversation = document.getElementById('voiceConversation');
        const voiceStatusIcon = document.getElementById('voiceStatusIcon');
        const voiceStatusText = document.getElementById('voiceStatusText');

        // Voice State
        let voiceSessionId = null;
        let isVoiceActive = false;
        let recognition = null;
        let isSpeaking = false;

        // Helper: Show loading state
        function showLoading(message = 'Processing...') {
            generateBtn.disabled = true;
            generateBtn.textContent = message;
        }

        // Helper: Hide loading state
        function hideLoading() {
            generateBtn.textContent = 'Generate AI Edit';
            updateGenerateButton();
        }

        // Helper: Fetch template image as blob
        async function fetchTemplateAsBlob(templatePath) {
            const response = await fetch(templatePath);
            if (!response.ok) {
                throw new Error(`Failed to load template: ${response.statusText}`);
            }
            const blob = await response.blob();
            return blob;
        }

        // Template Selection
        templateCards.forEach(card => {
            card.addEventListener('click', async () => {
                // Remove previous selection
                templateCards.forEach(c => c.classList.remove('selected'));

                // Select current template
                card.classList.add('selected');
                selectedTemplate = card.dataset.template;

                // Get the template image path from the img src
                const imgElement = card.querySelector('img');
                const templatePath = imgElement.src;

                // Update template preview
                selectedTemplatePreview.src = templatePath;
                selectedTemplatePreview.classList.add('active');
                templatePreviewPlaceholder.classList.add('hidden');

                showLoading('Loading template...');

                try {
                    // Fetch the template image as a blob
                    selectedTemplateFile = await fetchTemplateAsBlob(templatePath);

                    // Call describe endpoint to analyze the template
                    showLoading('Analyzing template...');
                    const formData = new FormData();
                    formData.append('file', selectedTemplateFile, `${selectedTemplate}.jpg`);

                    const describeResponse = await fetch('/describe', {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer aR2sR_NznoXbTWYgSw1Ptr3ZJZ1VKvNjUZodjoFqxiM'
                        },
                        body: formData
                    });

                    if (!describeResponse.ok) {
                        const error = await describeResponse.json();
                        throw new Error(error.detail || 'Failed to analyze template');
                    }

                    templateDescription = await describeResponse.json();
                    console.log('Template analysis:', templateDescription);

                    // Update UI with success
                    generateSubtitle.textContent = `Template analyzed: ${templateDescription.category || selectedTemplate}`;

                    // Optionally pre-fill textarea with template description
                    if (!changesTextarea.value.trim()) {
                        changesTextarea.placeholder = `This is a ${templateDescription.category}. ${templateDescription.description}\n\nDescribe what you want to change...`;
                    }

                } catch (error) {
                    console.error('Error loading template:', error);
                    alert(`Error: ${error.message}`);
                    // Deselect template on error
                    card.classList.remove('selected');
                    selectedTemplate = null;
                    selectedTemplateFile = null;
                    templateDescription = null;
                } finally {
                    hideLoading();
                }
            });
        });

        // Image Upload
        imageInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            const remainingSlots = MAX_IMAGES - uploadedImages.length;

            if (files.length > remainingSlots) {
                alert(`You can only upload ${MAX_IMAGES} images total. ${remainingSlots} slots remaining.`);
                return;
            }

            files.forEach(file => {
                if (uploadedImages.length < MAX_IMAGES) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        uploadedImages.push({
                            file: file,
                            dataUrl: e.target.result
                        });
                        renderImagePreviews();
                    };
                    reader.readAsDataURL(file);
                }
            });
        });

        function renderImagePreviews() {
            imagePreviewGrid.innerHTML = '';

            uploadedImages.forEach((image, index) => {
                const previewItem = document.createElement('div');
                previewItem.className = 'image-preview-item';
                previewItem.innerHTML = `
                    <img src="${image.dataUrl}" alt="Preview ${index + 1}">
                    <button class="image-preview-remove" onclick="removeImage(${index})">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                `;
                imagePreviewGrid.appendChild(previewItem);
            });

            // Update upload button text
            uploadBtnText.textContent = `Upload (${uploadedImages.length}/${MAX_IMAGES})`;
        }

        function removeImage(index) {
            uploadedImages.splice(index, 1);
            renderImagePreviews();
        }

        function updateGenerateButton() {
            if (selectedTemplate && selectedTemplateFile) {
                generateBtn.disabled = false;
                generateSubtitle.textContent = `Template ready: ${selectedTemplate.replace(/-/g, ' ')}`;
            } else {
                generateBtn.disabled = true;
                generateSubtitle.textContent = 'Select a template to begin';
            }
        }

        // Generate Button - Main workflow
        generateBtn.addEventListener('click', async () => {
            if (!selectedTemplate || !selectedTemplateFile) {
                alert('Please select a template first');
                return;
            }

            const changes = changesTextarea.value.trim();

            if (!changes) {
                alert('Please describe the changes you want to make');
                return;
            }

            showLoading('Generating AI edit...');

            try {
                // Prepare FormData for refine endpoint
                const formData = new FormData();
                formData.append('file', selectedTemplateFile, `${selectedTemplate}.jpg`);
                formData.append('prompt', changes);
                formData.append('strength', '0.7');  // Default strength
                formData.append('num_variations', '1');  // Single variation

                // Append reference images
                uploadedImages.forEach((imgObj, index) => {
                    formData.append('files', imgObj.file);
                });

                // Call refine/upload endpoint
                const refineResponse = await fetch('/refine/upload', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer aR2sR_NznoXbTWYgSw1Ptr3ZJZ1VKvNjUZodjoFqxiM'
                    },
                    body: formData
                });

                if (!refineResponse.ok) {
                    const error = await refineResponse.json();
                    throw new Error(error.detail || 'Failed to generate variations');
                }

                const result = await refineResponse.json();
                console.log('Generation result:', result);

                // Display results
                displayResults(result);

                // Show success message
                alert(`Successfully generated ${result.variations.length} variations!`);

            } catch (error) {
                console.error('Error generating:', error);
                alert(`Error: ${error.message}`);
            } finally {
                hideLoading();
            }
        });

        // Display results function
        function displayResults(result) {
            if (!result.variations || result.variations.length === 0) {
                alert('No variations were generated');
                return;
            }

            // Create a results modal or section
            const resultsHTML = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 1000; overflow-y: auto; padding: 2rem;">
                    <div style="max-width: 1200px; margin: 0 auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                            <h2 style="font-size: 1.5rem; color: var(--text-primary);">Generated Variations</h2>
                            <button onclick="this.parentElement.parentElement.parentElement.remove()" style="background: var(--error); color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.5rem; cursor: pointer;">Close</button>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                            ${result.variations.map((variation, index) => `
                                <div style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 1rem; overflow: hidden;">
                                    <img src="${variation.asset_uri}" alt="Variation ${index + 1}" style="width: 100%; aspect-ratio: 1; object-fit: cover;">
                                    <div style="padding: 1rem;">
                                        <h3 style="margin-bottom: 0.5rem;">Variation ${index + 1}</h3>
                                        <p style="font-size: 0.875rem; color: var(--text-secondary);">ID: ${variation.asset_id.substring(0, 8)}...</p>
                                        <a href="${variation.asset_uri}" download="variation_${index + 1}.jpg" style="display: inline-block; margin-top: 0.75rem; padding: 0.5rem 1rem; background: linear-gradient(135deg, var(--accent-green), var(--accent-yellow)); color: var(--bg-black); text-decoration: none; border-radius: 0.5rem; font-weight: 600;">Download</a>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', resultsHTML);
        }

        // =====================
        // BUSINESS ONBOARDING FLOW
        // =====================

        // DOM Elements
        const registerBusinessBtn = document.getElementById('registerBusinessBtn');

        // State
        let isOnboardingActive = false;
        let onboardingSessionId = null;





        // Helper: Add Message to UI
        function addVoiceMessage(role, text) {
            const msgDiv = document.createElement('div');
            msgDiv.className = `voice-message ${role}`;
            msgDiv.textContent = text;
            voiceConversation.appendChild(msgDiv);
            voiceConversation.scrollTop = voiceConversation.scrollHeight;
        }

        // Helper: Update Status UI
        function updateVoiceStatus(status, text) {
            voiceStatusText.textContent = text;
            voiceStatusIcon.className = 'voice-status-icon'; // reset

            if (status === 'listening') voiceStatusIcon.classList.add('listening');
            if (status === 'speaking') voiceStatusIcon.classList.add('speaking');
        }


        // =====================
        // AUTO-GENERATE FROM VOICE
        // =====================

        async function startGenerationWithVoicePrompt(prompt) {
            if (!selectedTemplate || !selectedTemplateFile) {
                alert('Please select a template first');
                return;
            }

            showLoading('ðŸŽ¨ Generating your design from voice prompt...');

            try {
                // Prepare FormData for refine endpoint
                const formData = new FormData();
                formData.append('file', selectedTemplateFile, `${selectedTemplate}.jpg`);
                formData.append('prompt', prompt);
                formData.append('strength', '0.7');
                formData.append('num_variations', '1');

                // Append reference images if any
                uploadedImages.forEach((imgObj, index) => {
                    formData.append('files', imgObj.file);
                });

                // Call refine/upload endpoint
                const refineResponse = await fetch('/refine/upload', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer aR2sR_NznoXbTWYgSw1Ptr3ZJZ1VKvNjUZodjoFqxiM'
                    },
                    body: formData
                });

                if (!refineResponse.ok) {
                    const error = await refineResponse.json();
                    throw new Error(error.detail || 'Failed to generate design');
                }

                const result = await refineResponse.json();
                console.log('Voice generation result:', result);

                // Display results
                displayResults(result);

                // Show success message
                alert(`âœ… Successfully generated ${result.variations.length} design(s) from your voice request!`);

            } catch (error) {
                console.error('Error generating from voice:', error);
                alert(`Error: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        // =====================
        // VOICE CONVERSATION - REALTIME WEBSOCKET (Smooth like ChatGPT)
        // =====================

        // WebSocket and Audio State
        let voiceWebSocket = null;
        let mediaRecorder = null;
        let audioStream = null;
        let audioContext = null;
        let audioSourceNodes = [];
        let isPlayingAudio = false;
        let pendingAudioChunks = [];
        let isMicMuted = false;  // Mute mic while AI is speaking to prevent feedback
        let isResponseDone = false; // Track if server has finished sending audio

        // Start Voice Conversation with WebSocket
        async function startVoiceConversation() {
            // Check if template is selected
            if (!selectedTemplate) {
                alert('Please select a template first before using voice assistant.');
                return;
            }

            // Open modal
            voiceModal.classList.add('active');
            isVoiceActive = true;

            // Clear previous conversation
            voiceConversation.innerHTML = '';
            updateVoiceStatus('initializing', 'Connecting...');

            try {
                // Get microphone access first
                audioStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        sampleRate: 24000
                    }
                });

                // Initialize audio context for playback
                audioContext = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 24000 });

                // Connect to WebSocket
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/voice/realtime`;

                console.log('Connecting to:', wsUrl);
                voiceWebSocket = new WebSocket(wsUrl);

                voiceWebSocket.onopen = async () => {
                    console.log('WebSocket connected');
                    updateVoiceStatus('connected', 'Connected! Speak now...');

                    // Start continuous audio streaming
                    await startContinuousStreaming();
                };

                voiceWebSocket.onmessage = async (event) => {
                    try {
                        const message = JSON.parse(event.data);
                        await handleRealtimeEvent(message);
                    } catch (error) {
                        console.error('Error handling message:', error);
                    }
                };

                voiceWebSocket.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    updateVoiceStatus('error', 'Connection error. Retrying...');
                };

                voiceWebSocket.onclose = (event) => {
                    console.log('WebSocket closed:', event.code, event.reason);
                    if (isVoiceActive) {
                        updateVoiceStatus('disconnected', 'Disconnected');
                    }
                };

            } catch (error) {
                console.error('Error starting voice conversation:', error);
                if (error.name === 'NotAllowedError') {
                    alert('Microphone access denied. Please allow microphone access.');
                } else {
                    alert(`Failed to start: ${error.message}`);
                }
                closeVoiceConversation();
            }
        }

        // Start Continuous Audio Streaming (like ChatGPT)
        async function startContinuousStreaming() {
            try {
                // Use AudioWorklet or ScriptProcessor for raw PCM streaming
                const source = audioContext.createMediaStreamSource(audioStream);
                const processor = audioContext.createScriptProcessor(4096, 1, 1);

                processor.onaudioprocess = (e) => {
                    // Don't send audio while AI is speaking (prevents feedback loop)
                    if (!isVoiceActive || !voiceWebSocket || voiceWebSocket.readyState !== WebSocket.OPEN || isMicMuted) {
                        return;
                    }

                    // Get audio data
                    const inputData = e.inputBuffer.getChannelData(0);

                    // Convert to 16-bit PCM
                    const pcm16 = new Int16Array(inputData.length);
                    for (let i = 0; i < inputData.length; i++) {
                        const s = Math.max(-1, Math.min(1, inputData[i]));
                        pcm16[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
                    }

                    // Convert to base64
                    const base64Audio = btoa(String.fromCharCode(...new Uint8Array(pcm16.buffer)));

                    // Send to server
                    voiceWebSocket.send(JSON.stringify({
                        type: 'input_audio_buffer.append',
                        audio: base64Audio
                    }));
                };

                source.connect(processor);
                processor.connect(audioContext.destination);

                updateVoiceStatus('listening', 'ðŸŽ¤ Listening... Just speak naturally');
                console.log('Continuous audio streaming started');

            } catch (error) {
                console.error('Error starting continuous streaming:', error);
                // Fallback to MediaRecorder approach
                await startMediaRecorderStreaming();
            }
        }

        // Fallback: MediaRecorder streaming
        async function startMediaRecorderStreaming() {
            mediaRecorder = new MediaRecorder(audioStream, {
                mimeType: 'audio/webm;codecs=opus'
            });

            mediaRecorder.ondataavailable = async (event) => {
                // Don't send audio while AI is speaking (prevents feedback loop)
                if (event.data.size > 0 && voiceWebSocket && voiceWebSocket.readyState === WebSocket.OPEN && !isMicMuted) {
                    const reader = new FileReader();
                    reader.onload = () => {
                        const base64Audio = reader.result.split(',')[1];
                        voiceWebSocket.send(JSON.stringify({
                            type: 'input_audio_buffer.append',
                            audio: base64Audio
                        }));
                    };
                    reader.readAsDataURL(event.data);
                }
            };

            // Stream in small chunks for real-time effect
            mediaRecorder.start(100);
            updateVoiceStatus('listening', 'ðŸŽ¤ Listening... Just speak naturally');
        }

        // Handle Realtime API Events
        async function handleRealtimeEvent(event) {
            console.log('Realtime event:', event.type);

            switch (event.type) {
                case 'session.created':
                    voiceSessionId = event.session_id || event.sessionid;
                    console.log('Session created:', voiceSessionId);
                    break;

                case 'input_audio_buffer.speech_started':
                    updateVoiceStatus('listening', 'ðŸŽ¤ Hearing you...');
                    break;

                case 'input_audio_buffer.speech_stopped':
                    updateVoiceStatus('processing', 'ðŸ’­ Thinking...');
                    break;

                case 'conversation.item.input_audio_transcription.completed':
                    if (event.transcript) {
                        addVoiceMessage('user', event.transcript);
                    }
                    break;

                case 'response.audio.delta':
                    // Mute mic while AI is speaking to prevent feedback loop
                    if (!isMicMuted) {
                        isMicMuted = true;
                        isResponseDone = false;
                        console.log('Mic muted - AI speaking');
                    }
                    if (event.delta) {
                        await playAudioDelta(event.delta);
                    }
                    break;

                case 'response.audio_transcript.delta':
                    // Real-time transcript of AI speech
                    break;

                case 'response.audio_transcript.done':
                    if (event.transcript) {
                        addVoiceMessage('ai', event.transcript);
                    }
                    break;

                case 'response.done':
                    // Server is done sending, but audio might still be playing from queue
                    isResponseDone = true;
                    console.log('Server response done - waiting for playback to finish');

                    // If nothing is playing, we can unmute now
                    if (!isPlayingQueue && audioQueue.length === 0) {
                        setTimeout(() => {
                            isMicMuted = false;
                            console.log('Mic unmuted - nothing playing');
                            updateVoiceStatus('listening', 'ðŸŽ¤ Your turn... Just speak');
                        }, 300);
                    }
                    break;

                case 'conversation.complete':
                    if (event.final_prompt) {
                        // Extract the actual prompt from AI's response
                        // The AI says: "Here's the prompt I've created: [PROMPT]. Should I proceed?"
                        let extractedPrompt = event.final_prompt;

                        // Try to extract the prompt between "I've created:" and "Should I proceed"
                        const promptMatch = event.final_prompt.match(/(?:prompt[:\s]+|created[:\s]+)(.*?)(?:\.\s*should|,\s*should|\?\s*$)/is);
                        if (promptMatch && promptMatch[1]) {
                            extractedPrompt = promptMatch[1].trim();
                        }

                        // Put the extracted prompt in the textarea
                        changesTextarea.value = extractedPrompt;
                        updateVoiceStatus('complete', 'âœ… Prompt created! Starting edit...');
                        updateGenerateButton();

                        // Auto-trigger the refine/edit process
                        setTimeout(async () => {
                            closeVoiceConversation();

                            // Automatically start the generation
                            if (selectedTemplate && extractedPrompt) {
                                await startGenerationWithVoicePrompt(extractedPrompt);
                            }
                        }, 1500);
                    }
                    break;

                case 'error':
                    console.error('Realtime API error:', event);
                    const errorMsg = event.error?.message || event.error || 'Unknown error';
                    updateVoiceStatus('error', `Error: ${errorMsg}`);
                    break;
            }
        }

        // Audio queue for sequential playback
        let audioQueue = [];
        let isPlayingQueue = false;
        let nextPlayTime = 0;

        // Play audio delta (queued sequential playback)
        async function playAudioDelta(base64Audio) {
            try {
                // Decode base64 to PCM16
                const binaryString = atob(base64Audio);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }

                // Convert PCM16 to Float32 for Web Audio API
                const pcm16 = new Int16Array(bytes.buffer);
                const float32 = new Float32Array(pcm16.length);
                for (let i = 0; i < pcm16.length; i++) {
                    float32[i] = pcm16[i] / 32768;
                }

                // Create audio buffer
                const audioBuffer = audioContext.createBuffer(1, float32.length, 24000);
                audioBuffer.getChannelData(0).set(float32);

                // Add to queue
                audioQueue.push(audioBuffer);

                // Start playing if not already
                if (!isPlayingQueue) {
                    playFromQueue();
                }

            } catch (error) {
                console.error('Error processing audio delta:', error);
            }
        }

        // Play audio buffers sequentially from queue
        function playFromQueue() {
            if (audioQueue.length === 0) {
                isPlayingQueue = false;
                return;
            }

            isPlayingQueue = true;
            updateVoiceStatus('speaking', 'ðŸ”Š AI speaking...');

            const audioBuffer = audioQueue.shift();
            const source = audioContext.createBufferSource();
            source.buffer = audioBuffer;
            source.connect(audioContext.destination);

            // Schedule to play at the right time to avoid gaps
            const currentTime = audioContext.currentTime;
            const startTime = Math.max(currentTime, nextPlayTime);

            source.start(startTime);
            nextPlayTime = startTime + audioBuffer.duration;

            // When this chunk ends, play the next
            source.onended = () => {
                if (audioQueue.length > 0) {
                    playFromQueue();
                } else {
                    isPlayingQueue = false;
                    // If server is also done, we can finally unmute
                    if (isResponseDone) {
                        setTimeout(() => {
                            isMicMuted = false;
                            console.log('Mic unmuted - playback finished');
                            updateVoiceStatus('listening', 'ðŸŽ¤ Your turn... Just speak');
                        }, 300); // 300ms safety delay for echo tails
                    }
                }
            };
        }

        // Add Voice Message to UI
        function addVoiceMessage(role, text) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `voice-message ${role}`;
            messageDiv.textContent = text;

            const existingStatus = voiceConversation.querySelector('.voice-status');
            if (existingStatus) {
                existingStatus.remove();
            }

            voiceConversation.appendChild(messageDiv);
            voiceConversation.scrollTop = voiceConversation.scrollHeight;
        }

        // Update Voice Status
        function updateVoiceStatus(type, text) {
            let statusDiv = voiceConversation.querySelector('.voice-status');
            if (!statusDiv) {
                statusDiv = document.createElement('div');
                statusDiv.className = 'voice-status';
                statusDiv.innerHTML = `
                    <div class="voice-status-icon" id="voiceStatusIcon">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="width: 24px; height: 24px">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                        </svg>
                    </div>
                    <p id="voiceStatusText"></p>
                `;
                voiceConversation.appendChild(statusDiv);
            }

            const icon = statusDiv.querySelector('.voice-status-icon');
            const textEl = statusDiv.querySelector('#voiceStatusText');

            if (icon && textEl) {
                icon.className = 'voice-status-icon';
                if (type === 'listening') icon.classList.add('listening');
                else if (type === 'speaking') icon.classList.add('speaking');
                textEl.textContent = text;
            }
        }

        // Close Voice Conversation
        function closeVoiceConversation() {
            isVoiceActive = false;
            voiceModal.classList.remove('active');

            // Stop media recorder
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
            mediaRecorder = null;

            // Stop audio stream
            if (audioStream) {
                audioStream.getTracks().forEach(track => track.stop());
                audioStream = null;
            }

            // Close WebSocket
            if (voiceWebSocket) {
                voiceWebSocket.close();
                voiceWebSocket = null;
            }

            // Close audio context
            if (audioContext && audioContext.state !== 'closed') {
                audioContext.close();
            }
            audioContext = null;

            // Reset audio queue
            audioQueue = [];
            isPlayingQueue = false;
            nextPlayTime = 0;
            voiceSessionId = null;
        }

        // Voice Button Click
        voiceBtn.addEventListener('click', () => {
            startVoiceConversation();
        });

        // Voice Modal Close
        voiceModalClose.addEventListener('click', () => {
            closeVoiceConversation();
        });

        // Close modal on backdrop click
        voiceModal.addEventListener('click', (e) => {
            if (e.target === voiceModal) {
                closeVoiceConversation();
            }
        });

        // Drag and drop for textarea
        changesTextarea.addEventListener('dragover', (e) => {
            e.preventDefault();
            changesTextarea.style.borderColor = 'var(--accent-green)';
        });

        changesTextarea.addEventListener('dragleave', () => {
            changesTextarea.style.borderColor = 'var(--border-light)';
        });

        changesTextarea.addEventListener('drop', (e) => {
            e.preventDefault();
            changesTextarea.style.borderColor = 'var(--border-light)';

            const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
            if (files.length > 0) {
                const dataTransfer = new DataTransfer();
                files.forEach(f => dataTransfer.items.add(f));
                imageInput.files = dataTransfer.files;
                imageInput.dispatchEvent(new Event('change'));
            }
        });
    </script>
</body>

</html>